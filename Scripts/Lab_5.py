from time import sleep
import rospy
from std_msgs.msg import String
from sensor_msgs.msg import JointState
from trajectory_msgs.msg import JointTrajectory, JointTrajectoryPoint
import numpy as np

def joint_publisher():
    pub = rospy.Publisher('/joint_trajectory', JointTrajectory, queue_size=0)
    rospy.init_node('joint_publisher', anonymous=False)
    
    while not rospy.is_shutdown():
        state = JointTrajectory()
        state.header.stamp = rospy.Time.now()
        state.joint_names = ["joint_1", "joint_2", "joint_3", "joint_4", "joint_5"]
        point = JointTrajectoryPoint()
        
        movimiento(point, state, pub)
        
        
def movimiento(point, state, pub):
    a = 1
    
    while(a != 0):
        trayectoria0 = [[0.0496,-0.2396,0.0455],[0.0605,-0.2521,0.0455],[0.0664,-0.2590,0.043], 
                        [0.0664,-0.2590,0.03]]
        trayectoria1 = [
            [0.053704,0.292613,0.01],[0.070964,0.288912,0.0],[0.087973,0.284195,0.0],
            [0.104673,0.278478,0.0000],[0.121004,0.27178,0.0000],[0.136909,0.264125,0.0000],
            [0.152333,0.255541,0.0000],[0.16722,0.246056,0.0000],[0.181518,0.235706,0.0000],
            [0.195178,0.224526,0.0000],[0.20815,0.212556,0.0000],[0.220389,0.199837,0.0000],
            [0.231853,0.186415,0.0000],[0.242501,0.172336,0.0000],[0.252294,0.157651,0.0000],
            [0.2612,0.142411,0.0000],[0.269186,0.126669,0.0000],[0.276225,0.110482,0.0000],
            [0.282291,0.093906,0.0000],[0.287363,0.076999,0.0000],[0.291424,0.059821,0.0000],
            [0.294458,0.042432,0.0000],[0.296457,0.024894,0.0000],[0.297411,0.007269,0.0000],
            [0.297319,-0.010383,0.0000],[0.29618,-0.027997,0.0000],[0.293998,-0.045513,0.0000],
            [0.290781,-0.062869,0.0000],[0.286541,-0.080004,0.0000],[0.281292,-0.096857,0.0000],
            [0.275052,-0.113368,0.0000],[0.267845,-0.129481,0.0000],[0.259694,-0.145138,0.0000],
            [0.25063,-0.160284,0.0000],[0.240683,-0.174866,0.0000],[0.229888,-0.188832,0.0000],
            [0.218285,-0.202134,0.0000],[0.205913,-0.214724,0.0000],[0.192816,-0.226558,0.0000],
            [0.17904,-0.237594,0.0000],[0.164634,-0.247794,0.00],[0.149648,-0.257122,0.00],
            [0.134136,-0.265544,0.01]
        ]
        trayectoria2 = [
            [0.0269,0.1463,0.08],[0.0455,0.1445,0.06],[0.0440,0.1421,0.0455],
            [0.0523,0.1392,0.0455],[0.0685,0.1321,0.0455],[0.0762,0.1278,0.0455],
            [0.0836,0.1230,0.0455],[0.0908,0.1179,0.0455],[0.0976,0.1123,0.0455],
            [0.1041,0.1063,0.0455],[0.1102,0.0999,0.0455],[0.1159,0.0932,0.0455],
            [0.1213,0.0862,0.0455],[0.1262,0.0788,0.0455],[0.1306,0.0712,0.0455],
            [0.1346,0.0633,0.0455],[0.1381,0.0552,0.0455],[0.1412,0.0470,0.0455],
            [0.1437,0.0385,0.0455],[0.1457,0.0299,0.0455],[0.1472,0.0212,0.0455],
            [0.1482,0.0124,0.0455],[0.1487,0.0036,0.0455],[0.1487,-0.0052,0.0455],
            [0.1481,-0.0140,0.0455],[0.1470,-0.0228,0.0455],[0.1454,-0.0314,0.0455],
            [0.1433,-0.0455,0.0455],[0.1407,-0.0484,0.0455],[0.1375,-0.0567,0.0455],
            [0.1339,-0.0647,0.0455],[0.1299,-0.0726,0.0455],[0.1253,-0.0801,0.0455],
            [0.1203,-0.0874,0.0455],[0.1150,-0.0944,0.0455],[0.1092,-0.1011,0.0455],
            [0.1030,-0.1074,0.0455],[0.0964,-0.1133,0.0455],[0.0895,-0.1188,0.0455],
            [0.0823,-0.1239,0.0455],[0.0748,-0.1286,0.0455],[0.0671,-0.1328,0.0455],
            [0.0591,-0.1365,0.0455],[0.0509,-0.1398,0.0455],[0.0425,-0.1426,0.0455],
            [0.0340,-0.1448,0.0455],[0.0253,-0.1466,0.06],[0.0166,-0.1478,0.08]
        ]
        trayectoria3 = [
            [0.1327,0.1948,0.0800],[0.1327,0.1948,0.0600],[0.1327,0.1948,0.0455],
            [0.1298,0.1922,0.0455],[0.1269,0.1896,0.0455],[0.1239,0.1870,0.0455],
            [0.1210,0.1844,0.0455],[0.1181,0.1818,0.0455],[0.1151,0.1792,0.0455],
            [0.1122,0.1766,0.0455],[0.1093,0.1740,0.0455],[0.1063,0.1715,0.0455],
            [0.1034,0.1689,0.0455],[0.1005,0.1663,0.0455],[0.0975,0.1637,0.0455],
            [0.0946,0.1611,0.0455],[0.0917,0.1585,0.0455],[0.0888,0.1559,0.0455],
            [0.0858,0.1533,0.0455],[0.0856,0.1553,0.0455],[0.0865,0.1591,0.0455],
            [0.0873,0.1629,0.0455],[0.0882,0.1667,0.0455],[0.0891,0.1706,0.0455],
            [0.0899,0.1744,0.0455],[0.0908,0.1782,0.0455],[0.0917,0.1820,0.0455],
            [0.0925,0.1858,0.0455],[0.0934,0.1896,0.0455],[0.0942,0.1934,0.0455],
            [0.0951,0.1973,0.0455],[0.0960,0.2011,0.0455],[0.0934,0.1993,0.0455],
            [0.0904,0.1968,0.0455],[0.0873,0.1943,0.0455],[0.0843,0.1918,0.0455],
            [0.0813,0.1893,0.0455],[0.0783,0.1868,0.0455],[0.0753,0.1843,0.0455],
            [0.0722,0.1819,0.0455],[0.0692,0.1794,0.0455],[0.0632,0.1744,0.0455],
            [0.0602,0.1719,0.0455],[0.0580,0.1708,0.0455],[0.0587,0.1746,0.0455],
            [0.0595,0.1785,0.0455],[0.0602,0.1823,0.0455],[0.0610,0.1861,0.0455],
            [0.0617,0.1900,0.0455],[0.0625,0.1938,0.0455],[0.0633,0.1977,0.0455],
            [0.0640,0.2015,0.0455],[0.0648,0.2053,0.0455],[0.0655,0.2092,0.0455],
            [0.0663,0.2130,0.0455],[0.0671,0.2168,0.0455],[0.0678,0.2207,0.0455],
            [0.0678,0.2207,0.0800], [0.0678,0.2207,0.0800]
        ]
        trayectoria3_1 = [
            [0.125822,0.126128,0.0800],
            [0.125822,0.126128,0.0600],
            [0.125822,0.126128,0.0455],
            [0.124792,0.121427,0.0455],
            [0.123957,0.116688,0.0455],
            [0.123513,0.111898,0.0455],
            [0.12392,0.107117,0.0455],
            [0.126339,0.103067,0.0455],
            [0.130857,0.1016,0.0455],
            [0.135663,0.101671,0.0455],
            [0.14044,0.102255,0.0455],
            [0.144788,0.103927,0.0455],
            [0.163745,0.11875,0.0455],
            [0.17891,0.130608,0.0455],
            [0.186492,0.136537,0.0455],
            [0.190284,0.139501,0.0455],
            [0.192163,0.142687,0.0455],
            [0.189151,0.146441,0.0455],
            [0.186138,0.150194,0.0455],
            [0.183126,0.153947,0.0455],
            [0.180113,0.1577,0.0455],
            [0.1771,0.161453,0.0455],
            [0.174088,0.165206,0.0455],
            [0.174088,0.165206,0.0600],
            [0.174088,0.165206,0.0800]
        ]
        trayectoria4 = [
            [0.1992,0.0693,0.0800],[0.1992,0.0693,0.0600],[0.1992,0.0693,0.0400],
            [0.2043,0.0744,0.0400],[0.2094,0.0795,0.0400],[0.2145,0.0846,0.0400],
            [0.2196,0.0896,0.0400],[0.2247,0.0947,0.0400],[0.2297,0.0998,0.0400],
            [0.2348,0.1049,0.0400],[0.2378,0.1020,0.0400],[0.2396,0.0950,0.0400],
            [0.2415,0.0881,0.0400],[0.2434,0.0811,0.0400],[0.2452,0.0742,0.0400],
            [0.2471,0.0672,0.0400],[0.2490,0.0602,0.0400],[0.2508,0.0533,0.0400],
            [0.2497,0.0493,0.0400],[0.2428,0.0511,0.0400],[0.2358,0.0530,0.0400],
            [0.2289,0.0549,0.0400],[0.2219,0.0567,0.0400],[0.2150,0.0586,0.0400],
            [0.2080,0.0605,0.0400],[0.2011,0.0623,0.0400],[0.1941,0.0642,0.0400],
            [0.1941,0.0642,0.0600],[0.1941,0.0642,0.0800]
        ]
        trayectoria5 = [
            [0.2248,0.0166,0.08],[0.2237,0.0120,0.0455],[0.2219,0.0076,0.0455],
            [0.2195,0.0036,0.0455],[0.2164,0.0001,0.0455],[0.2128,-0.0030,0.0455],
            [0.2088,-0.0055,0.0455],[0.2045,-0.0073,0.0455],[0.1999,-0.0084,0.0455],
            [0.1952,-0.0087,0.0455],[0.1905,-0.0084,0.0455],[0.1859,-0.0073,0.0455],
            [0.1816,-0.0055,0.0455],[0.1776,-0.0030,0.0455],[0.1740,0.0001,0.0455],
            [0.1709,0.0036,0.0455],[0.1685,0.0076,0.0455],[0.1667,0.0120,0.0455],
            [0.1656,0.0166,0.0455],[0.1652,0.0213,0.0455],[0.1656,0.0260,0.0455],
            [0.1667,0.0305,0.0455],[0.1685,0.0349,0.0455],[0.1709,0.0389,0.0455],
            [0.1740,0.0425,0.0455],[0.1776,0.0455,0.0455],[0.1816,0.0480,0.0455],
            [0.1859,0.0498,0.0455],[0.1905,0.0509,0.0455],[0.1952,0.0513,0.0455],
            [0.1999,0.0509,0.0455],[0.2045,0.0498,0.0455],[0.2088,0.0480,0.0455],
            [0.2128,0.0455,0.0455],[0.2164,0.0425,0.0455],[0.2195,0.0389,0.0455],
            [0.2219,0.0349,0.0455],[0.2237,0.0305,0.0455],[0.2248,0.0260,0.0455],
            [0.2252,0.0213,0.0455],[0.2203,0.0377,0.0455],[0.1989,-0.0085,0.0455],
            [0.1668,0.0310,0.08]
        ]
        trayectoria6 = [
            [0.2131,-0.0116,0.08],[0.2131,-0.0116,0.0355],[0.2171,-0.0116,0.0355],[0.2211,-0.0115,0.0355],[0.2251,-0.0115,0.0355],[0.2291,-0.0115,0.0355],[0.2331,-0.0115,0.0355],[0.2371,-0.0114,0.0355],[0.2411,-0.0114,0.0355],[0.2451,-0.0114,0.0355],[0.2491,-0.0113,0.0355],[0.2531,-0.0113,0.0355],[0.2571,-0.0113,0.0355],[0.2611,-0.0112,0.0355],[0.2651,-0.0112,0.0355],[0.2651,-0.0112,0.08],
            [0.2132,-0.0266,0.08],[0.2132,-0.0266,0.0455],[0.2172,-0.0265,0.0455],[0.2212,-0.0265,0.0455],[0.2252,-0.0265,0.0455],[0.2292,-0.0264,0.0455],[0.2332,-0.0264,0.0455],[0.2372,-0.0264,0.0455],[0.2412,-0.0263,0.0455],[0.2452,-0.0263,0.0455],[0.2492,-0.0263,0.0455],[0.2532,-0.0263,0.0455],[0.2572,-0.0262,0.0455],[0.2612,-0.0262,0.0455],[0.2652,-0.0262,0.0455],[0.2652,-0.0262,0.08],
            [0.2129,-0.0416,0.08],[0.2129,-0.0416,0.0455],[0.2169,-0.0416,0.0455],[0.2209,-0.0415,0.0455],[0.2249,-0.0415,0.0455],[0.2289,-0.0415,0.0455],[0.2329,-0.0415,0.0455],[0.2369,-0.0414,0.0455],[0.2409,-0.0414,0.0455],[0.2449,-0.0414,0.0455],[0.2489,-0.0413,0.0455],[0.2529,-0.0413,0.0455],[0.2569,-0.0413,0.0455],[0.2609,-0.0412,0.0455],[0.2649,-0.0412,0.0455],[0.2689,-0.0412,0.0455]
        ]
        trayectoria7 = [
            [0.204531,-0.187876,0.040],[0.204531,-0.187876,0.0255],[0.204531,-0.187876,0.040],
            [0.188128,-0.204424,0.040],[0.188128,-0.204424,0.0255],[0.188128,-0.204424,0.040],
            [0.169047,-0.217796,0.040],[0.169047,-0.217796,0.0255],[0.169047,-0.217796,0.040],
            [0.147894,-0.227566,0.040],[0.147894,-0.227566,0.0255],[0.147894,-0.227566,0.040],
            [0.125342,-0.233424,0.040],[0.125342,-0.233424,0.0255],[0.125342,-0.233424,0.040],
            [0.102108,-0.235182,0.040],[0.102108,-0.235182,0.0255],[0.102108,-0.235182,0.040]
        ]
        trayectoria8 = [
            [0.0970,-0.1717,0.0700],[0.0970,-0.1717,0.0455], [0.0970,-0.1717,0.08],
            [0.0930,-0.1780,0.08],[0.0930,-0.1780,0.0455],[0.0889,-0.1844,0.0455],
            [0.0849,-0.1907,0.0455],[0.2375,-0.1112,0.0455],[0.2301,-0.1124,0.0455],
            [0.2226,-0.1135,0.0455],[0.2152,-0.1147,0.0455],[0.2078,-0.1158,0.0455],
            [0.2004,-0.1170,0.0455],[0.1929,-0.1181,0.0455],[0.1855,-0.1193,0.0455],
            [0.1781,-0.1204,0.0455],[0.1706,-0.1216,0.0455],[0.1632,-0.1227,0.0455],
            [0.1558,-0.1239,0.0455],[0.1484,-0.1250,0.0455],[0.1409,-0.1261,0.0455],
            [0.1335,-0.1273,0.0455],[0.1261,-0.1284,0.0455],[0.1213,-0.1337,0.0455],
            [0.1173,-0.1400,0.0455],[0.1132,-0.1464,0.0455],[0.1092,-0.1527,0.0455],
            [0.1051,-0.1590,0.0455],[0.1011,-0.1654,0.0455],[0.0808,-0.1970,0.0455],
            [0.0785,-0.2031,0.0455],[0.0841,-0.2081,0.0455],[0.0897,-0.2131,0.0455],
            [0.0955,-0.2179,0.0455],[0.1014,-0.2226,0.0455],[0.1076,-0.2267,0.0455],
            [0.1145,-0.2297,0.0455],[0.1210,-0.2271,0.0455],[0.1227,-0.2198,0.0455],
            [0.1233,-0.2123,0.0455],[0.1242,-0.2048,0.0455],[0.1262,-0.1976,0.0455],
            [0.1305,-0.1915,0.0455],[0.1366,-0.1872,0.0455],[0.1436,-0.1844,0.0455],
            [0.1509,-0.1827,0.0455],[0.1583,-0.1815,0.0455],[0.1658,-0.1806,0.0455],
            [0.1732,-0.1796,0.0455],[0.1806,-0.1783,0.0455],[0.1879,-0.1764,0.0455],
            [0.1949,-0.1737,0.0455],[0.2016,-0.1702,0.0455],[0.2077,-0.1659,0.0455],
            [0.2133,-0.1609,0.0455],[0.2184,-0.1554,0.0455],[0.2231,-0.1495,0.0455],
            [0.2273,-0.1433,0.0455],[0.2312,-0.1368,0.0455],[0.2349,-0.1303,0.0455],
            [0.2383,-0.1236,0.0455],[0.2417,-0.1169,0.0455],[0.2449,-0.1101,0.0455],
            [0.2449,-0.1101,0.0700]
        ]
        cerrar = [trayectoria0[2]]
        subir = [[0.0664,-0.2590,0.05]]
        
        dejar = [[0.0496,-0.2396,0.0455],[0.0605,-0.2521,0.0455],[0.0664,-0.2590,0.043], 
                        [0.0664,-0.2590,0.03]]
        
        abrir = [dejar[2]]
        
        print(f'''Trayectorias definidas:
        0. Agarrar marcador
        1. Alcance máximo 
        2. Alcance minimo 
        3. Iniciales de integrantes 
        4. Figura: Triangulo 
        5. Figura: Circulo
        6. Figura: Lineas Paralelas
        7. Figura: Puntos equidistantes
        8. Figura específica
        9. HOME y soltar marcador''')
        b = int(input('Ingrese la posicion: '))
        
        print(f'Posicion {b}')
    
        if b == 0:
            sleep(1)
            Posicion1(trayectoria0, pub)
            sleep(1)
            Posicion(cerrar, pub)
            sleep(1)
            Posicion(subir, pub)
            sleep(1)
            home(point, state, pub)
        elif b == 1:
            sleep(1)
            Posicion(trayectoria1, pub)
            sleep(1)
            home(point, state, pub)
        elif b == 2:
            sleep(1)
            Posicion(trayectoria2, pub)
            sleep(1)
            home(point, state, pub)
        elif b == 3:
            sleep(1)
            Posicion(trayectoria3, pub)
            sleep(1)
            Posicion(trayectoria3_1, pub)
            sleep(1)
            home(point, state, pub)
        elif b == 4:
            sleep(1)
            Posicion(trayectoria4, pub)
            sleep(1)
            home(point, state, pub)
        elif b == 5:
            sleep(1)
            Posicion(trayectoria5, pub)
            sleep(1)
            home(point, state, pub)
        elif b == 6:
            sleep(1)
            Posicion(trayectoria6, pub)
            sleep(1)
            home(point, state, pub)
        elif b == 7:
            sleep(1)
            Posicion(trayectoria7, pub)
            sleep(1)
            home(point, state, pub)
        elif b == 8:
            sleep(1)
            Posicion(trayectoria8, pub)
            sleep(1)
            home(point, state, pub)
        elif b == 9:
            sleep(1)
            Posicion(dejar, pub)
            sleep(1)
            Posicion1(abrir, pub)
            
            sleep(1)
            point.positions = [0, 2.2, -2.356, -1.3, 0]
            point.time_from_start = rospy.Duration(0.5)
            state.points.append(point)
            pub.publish(state)
            print('published command')
            rospy.sleep(1)
            
            sleep(1)
            point.positions = [0, 2.2, -2.356, -1.3, 0]
            point.time_from_start = rospy.Duration(0.5)
            state.points.append(point)
            pub.publish(state)
            print('published command')
            rospy.sleep(1)
        else: 
            a = 0
            print('Cerrando movimiento...')
        
    print('Fuera de while')
    
def home(point, state, pub):
    
    point.positions = [0, 2.2, -2.356, -1.3, -2]
    point.time_from_start = rospy.Duration(0.5)
    state.points.append(point)
    pub.publish(state)
    print('published command')
    rospy.sleep(1)
    
def Posicion(puntos, pub):
    
    for punto in puntos:
        x = punto[0]
        y = punto[1]
        z = punto[2]

        state = JointTrajectory()
        state.header.stamp = rospy.Time.now()
        state.joint_names = ["joint_1", "joint_2", "joint_3", "joint_4", "joint_5"]
        point = JointTrajectoryPoint()
        point.positions = cInversa(x,y,z)
        point.time_from_start = rospy.Duration(0.4)
        state.points.append(point)
        pub.publish(state)
        rospy.sleep(2)

def cInversa(x,y,z):
    L1 = 0.105
    L2 = 0.105
    
    r = np.sqrt(x**2 + y**2) - 0.11
    z = 0.08 + z
    cosq3 = (r**2 + z**2 - L1**2 - L2**2)/(2*L1*L2)
    senq3 = np.sqrt(1 - cosq3**2)
    Theta3 = np.arctan2(senq3, cosq3)
    Theta2 = (np.arctan2(z,r) - np.arctan2(L2*senq3, L1 + L2*cosq3))
    Theta1 = np.arctan2(y,x)
    Theta4=(-Theta2+Theta3)
    angulos=[Theta1, -(np.pi/2 - Theta2), -1*Theta3, Theta4, -2]
    print(angulos)
    return angulos

def Posicion1(puntos, pub):
    
    for punto in puntos:
        x = punto[0]
        y = punto[1]
        z = punto[2]

        state = JointTrajectory()
        state.header.stamp = rospy.Time.now()
        state.joint_names = ["joint_1", "joint_2", "joint_3", "joint_4", "joint_5"]
        point = JointTrajectoryPoint()
        point.positions = cInversa1(x,y,z)
        point.time_from_start = rospy.Duration(0.4)
        state.points.append(point)
        pub.publish(state)
        rospy.sleep(2)

def cInversa1(x,y,z):
    L1 = 0.105
    L2 = 0.105
    
    r = np.sqrt(x**2 + y**2) - 0.11
    z = 0.08 + z
    cosq3 = (r**2 + z**2 - L1**2 - L2**2)/(2*L1*L2)
    senq3 = np.sqrt(1 - cosq3**2)
    Theta3 = np.arctan2(senq3, cosq3)
    Theta2 = (np.arctan2(z,r) - np.arctan2(L2*senq3, L1 + L2*cosq3))
    Theta1 = np.arctan2(y,x)
    Theta4=(-Theta2+Theta3)
    angulos=[Theta1, -(np.pi/2 - Theta2), -1*Theta3, Theta4, -1]
    print(angulos)
    return angulos

if __name__ == '__main__':
    try:
        joint_publisher()
    except rospy.ROSInterruptException:
        pass
